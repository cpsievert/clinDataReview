
<!--- 
This report display a listing table for a dataset and variables of interest.

Input parameters:
 
* Report-specific:
- reportTitle: string with report title
- reportTitleLevel: integer with level of the report title, 1 for chapter, 2 for section, ...
- dataFileName: string with name of the file of interest
- dataProcessing (optional): list with parameters for data processing, see ? medicalMonitoring::processData
- tableParams: list with any parameters for the table, see ? medicalMonitoring::tableMonitoring
(besides data/labelVars/pathVar/pathLab)
- comparisonTableType (optional): string with type of comparison table, either: 'none' (by default), 'newData-diff' or 'table-comparison-interactive'
- comparisonTableParams (optional): list with parameters for the comparison table, see ? glpgUtilityFct::compareTables
- loopingVar (optional): character vector with variables to loop over, a listing will be created for each combination of groups of this variable
- loopingNMax (optional): integer with maximal number of groups to consider (all by default)

* General:
- pathDataFolder: string with path to the data folder
- pathDataFolderOld (optional): string with path to the folder for old data
- patientProfilePath: string with relative path where patient profiles are stored

-->


```{r listingTemplate-options, echo = FALSE, warning = FALSE, message = FALSE}

library(knitr)
opts_chunk$set(
	echo = FALSE, 
	warning = FALSE, error = FALSE, message = FALSE, 
	results = "asis"
)

knitr::knit_hooks$set(
	message = function(x, options) {
		paste('\n\n<div class="alert alert-info">',
			gsub('##', '\n', x),
			'</div>', sep = '\n')
	}
)

# print warnings where they occur (warn = 0 by default)
options(warn = 1)

```

```{r listingTemplate-attachParameters}

attach(params)
if(!exists("comparisonTableType"))	comparisonTableType <- "none"
if(!exists("patientProfilePath"))	patientProfilePath <- NULL
if(!exists("loopingVar")) loopingVar <- NULL
if(!exists("loopingTotal"))	loopingTotal <- TRUE

```

```{r listingTemplate-loadPackages}

library(glpgUtilityFct)
library(inTextSummaryTable)
library(medicalMonitoring)
#library(plyr)

```

```{r listingTemplate-setTitle}

if(!exists("reportTitleLevel"))	reportTitleLevel <- 1

# Create a header at the wanted depth
cat(getMdHeader(title = reportTitle, level = reportTitleLevel))

```

```{r listingTemplate-getData}

if(comparisonTableType != "none") {
	
	if(!exists("pathDataFolderOld"))	stop("'pathDataFolderOld' should be specified.")
	
	pathsData <- c(
		"currentData" = pathDataFolder,
		"previousData" = pathDataFolderOld
	)	
	
} else pathsData <- c("currentData" = pathDataFolder)

dataList <- sapply(names(pathsData), function(dataBatch) {
			
	# Load data
	pathData <- file.path(pathsData[[dataBatch]], dataFileName)
	
	dataAll <- loadDataADaMSDTM(pathData, verbose = FALSE)
	data <- dataAll[[1]]
	
	# Extract label information
	labelVars <- attr(dataAll, "labelVars")
	
	# Data processing 
	if(exists("dataProcessing")){
		data <- processData(
			data = data, 
			dataPath = pathDataFolder,
			processing = dataProcessing,
			verbose = TRUE,
			labelVars = labelVars
		)
		# Labels updated with extra annotation:
		labelVars <- attr(data, "labelVars")
	}
	
	# Create URL to patient profiles
	if(!is.null(patientProfilePath))
		data <- createPatientProfileVar(
			data = data, 
			patientProfilePath = patientProfilePath,
			checkExist = FALSE
		)
	
	# only subset of the data if requested
	if(!is.null(loopingVar) && exists("loopingNMax") &&	is.integer(loopingNMax)){
		
		data <- merge(
			x = data,
			y = unique(data[, loopingVar, drop = FALSE])[seq_len(loopingNMax), , drop = FALSE],
			all = FALSE
		)
		
	}
	
	data
	
}, simplify = FALSE)

dataPrevious <- dataList$previousData
dataCurrent <- dataList$currentData
labelVars <- attr(dataCurrent, "labelVars")

```

```{r listingTemplate-getListingTable, eval = (comparisonTableType  == "none"), message = TRUE}	

data <- dlply(dataCurrent, loopingVar, function(dataCurrentI){
			
	argsTable <- c(
		list(
			data = dataCurrentI, 
			labelVars = labelVars,
			pathVar = if(!is.null(patientProfilePath))	"patientProfilePath",
			pathLab = labelVars["USUBJID"]
		),
		tableParams
	)
	do.call("tableMonitoring", argsTable)
	
})

knitPrintMedicalMonitoring(data, level = reportTitleLevel + 1)

```

```{r listingTemplate-getListingComparisonTable, eval = (comparisonTableType %in% c("newData-diff", "table-comparison-interactive")), message = TRUE}	

data <- dlply(dataCurrent, loopingVar, function(dataCurrentI){

	# get comparison table
	dataPreviousI <- merge(
		x = unique(dataCurrentI[, loopingVar, drop = FALSE]),
		y = dataPrevious,
		by = loopingVar,
		all = FALSE
	)
	argsCompTable <- c(
		list(
			newData = dataCurrentI,
			oldData = dataPreviousI,
			labelVars = labelVars,
			patientProfilePath = patientProfilePath,
			outputType = comparisonTableType,
			checkExistPatientProfilePath = FALSE
		),
		comparisonTableParams
	)
	tableComparison <- do.call(compareTables, argsCompTable)
	
	# print listing
	if(comparisonTableType == "newData-diff"){
		
		tableParams$tableVars <- c(tableParams$tableVars, "Comparison type")		
		argsTable <- c(
			list(
				data = tableComparison, 
				labelVars = labelVars,
				pathVar = if(!is.null(patientProfilePath))	"patientProfilePath",
				pathLab = labelVars["USUBJID"]
			),
			tableParams
		)
		tableComparison <- do.call("tableMonitoring", argsTable)	
		
	}
	
	tableComparison
	
})

knitPrintMedicalMonitoring(data, level = reportTitleLevel + 1)

```