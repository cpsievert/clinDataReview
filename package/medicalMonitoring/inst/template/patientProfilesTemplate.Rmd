
<!--- 
This report create patient profiles for all subjects of interest for the specified dataset
(with the 'patientProfilesVis' package).

Input parameters:
 
* Report-specific:
- reportTitle: string with report title
- reportTitleLevel: integer with level of the report title, 1 for chapter, 2 for section, ...
- patientProfilesParams (optional): list with subject profiles parameters, see ? runPatientProfileTemplateReport
- tableParams (optional): list with parameters to create the table containing link to subject profiles,
   - dataFileName: string with file name to the dataset of interest used for the table
   - dataProcessing (optional): list with parameters for data processing of the data used for the table, see ? medicalMonitoring::processData
   - vars: character vector with variables of interest to display in the table

* General:
- pathDataFolder: string with path to the data folder
- study: string with study name
- version: string with data version
- patientProfilePath: string with relative path where subject profiles are stored

-->

```{r patientProfilesTemplate, echo = FALSE, warning = FALSE, message = FALSE}

library(knitr)
opts_chunk$set(
	echo = FALSE, 
	warning = FALSE, error = FALSE, message = FALSE, 
	results = "asis"
)

knitr::knit_hooks$set(
	message = function(x, options) {
		paste('\n\n<div class="alert alert-info">',
			gsub('##', '\n', x),
			'</div>', sep = '\n')
	}
)

# print warnings where they occur (warn = 0 by default)
options(warn = 1)

```

```{r patientProfilesTemplate-attachParameters}
attach(params)
```

```{r patientProfilesTemplate-loadPackages}

library(glpgStyle)
library(glpgUtilityFct)
library(patientProfilesVis)

```

```{r patientProfilesTemplate-setTitle}

if(!exists("reportTitleLevel"))	reportTitleLevel <- 1

# Create a header at the wanted depth
cat(getMdHeader(title = reportTitle, level = reportTitleLevel))

```

```{r patientProfilesTemplate-getData}

# Load data
pathFiles <- list.files(path = pathDataFolder, pattern = "*.sas7bdat$", full.names = TRUE)

if(length(pathFiles) == 0)
	stop(paste0("No data is available in:", params$dataPath, "."))

tmp <- system.time(dataAll <- loadDataADaMSDTM(files = pathFiles))
labelVars <- attr(dataAll, "labelVars")

cat("Data is available for the datasets:", toString(names(dataAll)), ".")

```

```{r patientProfilesTemplate-setPlettes}

	colorPalette <- glpgStyle::glpgColor(c("main", "extra", "highlight"))

	# In ADaM-like format, date flag variables are formatted as following:
	shapePaletteDateFlag <- c(
		# u25A0 bigger square
		Complete = '\u25AA', Partial = '\u25CF', 
		`Missing start` = "\u25C0", `Missing end` = "\u25B6"
	)
	# convert date-flag variable to factor and returm warning if extra elements are present
	formatDateFlagVar <- function(x, type = c("start", "end")){
		type <- match.arg(type)
		# empty records should already be replaced by: 'Complete' in ADaM-like format
		idxEmpty <- which(x == "")
		x[idxEmpty] <- "Complete"
		levels <- names(shapePaletteDateFlag)
		palette <- shapePaletteDateFlag
		# add extra elements if present
		xExtra <- setdiff(unique(x), names(shapePaletteDateFlag))
		if(length(xExtra) > 0){
			warning("Flag variable contain non-standard elements:", toString(xExtra), ".")
			levels <- c(levels, xExtra)
			palette <- c(palette, setNames(seq_along(xExtra), xExtra))
		}
		xFact <- factor(x, levels = levels)
		return(list(x = xFact, palette = palette))
	}
	
	# color/shape palette for reference range indicator (abnormality lab/vs)
	shapePaletteRind <- c(
		`Low Panic` = '\u25BC', # big filled up-pointing arrow
		LOW = '\u25BC', Low = '\u25BC', # filled down-pointing arrow
		`Low Normal` = '\u25BC', # small filled down-pointing arrow
		NORMAL = '\u25CF', Normal = '\u25CF', # filled circle
		`High Normal` = '\u25B2', # small filled up-pointing arrow
		HIGH = '\u25B2', High = '\u25B2', # filled up-pointing arrow
		`High Panic` = '\u25B2', # big filled up-pointing arrow
		Abnormal = '\u2605', # star
		'NA' = '\u271A', # cross (3)
		Unknown = '\u271A'
	)
	colorPaletteRind <- c(
		`Low Panic` = unname(colorPalette["signalRed"]),
		LOW = unname(colorPalette["orange"]), Low = unname(colorPalette["orange"]),
		`Low Normal` = unname(colorPalette["yellow"]),
		NORMAL = unname(colorPalette["green"]), Normal = unname(colorPalette["green"]),
		`High Normal` = unname(colorPalette["yellow"]),
		HIGH = unname(colorPalette["orange"]), High = unname(colorPalette["orange"]),
		`High Panic` = unname(colorPalette["signalRed"]),
		Abnormal = unname(colorPalette["signalRed"]),
		'NA' = unname(colorPalette["grey"]),
		Unknown = unname(colorPalette["grey"])
	)

```

```{r patientProfiles-extractDataForGeneralParameters}	
	
	if(exists("patientProfilesGeneralParams")){
		
		# extract corresponding data for parameters specified with file name
		paramsDataFileName <- grep("DataFileName$", names(patientProfilesGeneralParams), value = TRUE)
		if(length(patientProfilesGeneralParams) > 0){
			
			# extract data name
			paramsData <- sub("FileName$", "", paramsDataFileName)
			
			# extract data
			patientProfilesGeneralParams[paramsData] <- lapply(paramsDataFileName, function(fileName){
				fileName <- patientProfilesGeneralParams[[fileName]]
				dataName <- toupper(tools::file_path_sans_ext(fileName))
				dataAll[[dataName]]
			})
	
			# remove parameters specifying file name(s)
			patientProfilesGeneralParams <- patientProfilesGeneralParams[setdiff(names(patientProfilesGeneralParams), paramsDataFileName)]	
			
		}
		
	}
	
```

```{r patientProfiles-buildModules, eval = exists("patientProfilesParams")}

	patientProfilesPlots <- list()

	for(iParams in seq_along(patientProfilesParams)){
		
		paramsPlotI <- patientProfilesParams[[iParams]]
		
		# plot-specific params
		label <- paramsPlotI[["plotParams"]][["label"]]
		if(is.null(label))	label <- paste("module", iParams)
		
		# extract data
		dataFileName <- paramsPlotI[["dataFileName"]]
		dataName <- toupper(tools::file_path_sans_ext(dataFileName))# extract data name
		data <- dataAll[[dataName]]
		if(is.null(data)){
			warning("Patient profiles:", label, "not created, because", 
				dataFileName, "is not specified or available.")
			break
		}
		
		# extra data-processing
		dataProcessing <- paramsPlotI[["dataProcessing"]]
		if(!is.null(dataProcessing)){
			
			data <- processData(
				data = data, 
				dataPath = pathDataFolder,
				processing = dataProcessing,
				verbose = TRUE,
				labelVars = labelVars
			)
			# Labels updated with extra annotation:
			labelVars <- attr(data, "labelVars")
			
		}

		# extract type of plot
		plotFctName <- paste0("subjectProfile", simpleCap(paramsPlotI[["typePlot"]]), "Plot")
		getFctRes <- try(
			plotFct <- do.call(`::`, list(pkg = "patientProfilesVis", name = plotFctName)),
			silent = TRUE
		)
		if(inherits(getFctRes, "try-error")){
			warning("Patient profiles:", label, "not created, because", 
				"'typePlot' is not specified or available in the 'patientProfilesVis' package.")
			break
		}
		
		# build fct call
		plotParams <- list(
			data = data,
			labelVars = labelVars
		)
		plotParams <- c(plotParams, paramsPlotI[["plotParams"]], patientProfilesGeneralParams)

		# create patient profiles for specified module
		listPlotsI <- do.call(plotFct, plotParams)
		message(paste("Subject profiles for", label, "created for", length(listPlotsI), "subject(s)."))
		
		# save plots
		patientProfilesPlots <- c(patientProfilesPlots, setNames(list(listPlotsI), label))
		
		# free memory
		rm(list = c("data", "plotParams", "listPlotsI"));tmp <- gc(verbose = FALSE) 
		
	}

```

```{r patientProfiles-createSubjectProfileReport, message = TRUE, warning = TRUE}

# TODO

if(!exists("patientProfilesPlots"))
	stop("Some patient profiles of interest should be specified.")

# dataset used to sort the subjects for the export
subjectSortData <- if(!is.null(params$subjectSortDataset))
	dataAll[[params$subjectSortDataset]]

pathsPatientProfiles <- createSubjectProfileReport(
	listPlots = patientProfilesPlots, 
	reportPerSubject = TRUE, 
	verbose = TRUE,
	outputFile = params$outputFile,
	timeAlign = "all", timeAlignPerSubject = "all",
	exportBatchSize = params$exportBatchSize,
	subjectSortData = subjectSortData,
	subjectSortVar = params$subjectSortVar,
	subjectSortDecreasing = params$subjectSortDecreasing
)

```

```{r patientProfiles-initialization}



```

The different data collected for each subject in this study are 
summarized in a subject specific profile report.

In the Medical Oversight and Monitoring Report, this report can displayed by:

* selecting an element in a specific visualization,
and clicking on the key 'P' (a.k.a 'Print Patient Profile').
For individual profiles, the report of the selected subject is opened
in the current browser. For visualization across patients 
(e.g. counts of adverse events), a compressed file is downloaded
with the subject profile reports for all selected patients.
* clicking on the link for a specific subject in each table
of the report

The table below summarizes the subject of interests for the study,
with their associated subject profile.

```{r patientProfilesTemplate-creation, eval = createPatientProfiles, results = "hide"}

set.seed(123) # in case subsetSample is specified
patientProfilePath <- file.path(patientProfilePath, "subjectProfile.pdf")
argsPatientProfiles <- c(
	list(
		dataPath = pathDataFolder, 
		outputFile = patientProfilePath,
		study = study,
		batch = version,
		# overwrite the subject profile template
		overwrite = TRUE,
		# create reports by batch of 10 patients:
		exportBatchSize = 10
	),
	if(exists("patientProfilesParams"))	patientProfilesParams
)

# create subject profile report
do.call(runPatientProfileTemplateReport, argsPatientProfiles)

```

```{r patientProfilesTemplate-table, eval = exists("tableParams")}

	pathData <- file.path(pathDataFolder, tableParams$dataFileName)

	dataAll <- loadDataADaMSDTM(pathData, verbose = FALSE)
	data <- dataAll[[1]]
	
	# Extract label information
	labelVars <- attr(dataAll, "labelVars")
	
	# Data processing 
	if(!is.null(tableParams$dataProcessing)){
		data <- processData(
			data = data, 
			dataPath = pathDataFolder,
			processing = tableParams$dataProcessing,
			verbose = TRUE,
			labelVars = labelVars
		)
		# Labels updated with extra annotation:
		labelVars <- attr(data, "labelVars")
	}
	
	# Create URL to subject profiles
	data <- createPatientProfileVar(
		data = data, 
		patientProfilePath = patientProfilePath,
		checkExist = FALSE
	)
	
	# Create the table
	tableMonitoring(
		data = data,
		tableVars = tableParams$vars,
		pathVar = "patientProfilePath", pathExpand = FALSE,
		labelVars = labelVars
	)

```