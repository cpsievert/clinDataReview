---
title: "Reporting with the `medicalMonitoring` package"
author: "Laure Cougnaud"
date: "`r format(Sys.Date(), '%B %d, %Y')`"
params:
  createPatientProfiles: false
output: 
  rmarkdown::html_document:
    toc: true
    toc_float: true
    toc_depth: 5
    number_sections: true
vignette: >
  %\VignetteIndexEntry{Reporting with the medicalMonitoring package}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---


Utility functions are provided to run a standard medical monitoring report.
Please note that the examples in this section are only informative, and not
evaluated in the vignette itself.

# File structure

## Input

The input for the medical monitoring report consists of a set of _Rmardown_
files and a `config` directory. Below more specifications.

**Rmd files**

A set of _Rmarkdown_ files in the working directory should be

* _index.Rmd_ file, containing the front page of the document.  
This file should be formatted as a _Rmarkdown_ report with _YAML_ header, with
  `output` set to: `medicalMonitoring::gitbook_medicalMonitoring_report`

* multiple Rmd files, one for each chapter (or template for multiple chapters)

**Config files**

There should be a `config` directory containing:

* a general configuration file: _config.yml_ with:
    
    + `pathDataFolder`: path to a directory containing input data in _sas7bdat_
           or _xpt_ format
    + `patientProfilesPath`(optional) : path to a directory containing the
      patient profiles
    + `study` (optional): study name
    + `version` (optional): data version, e.g. batch
    
* a configuration file for each chapter, as: _config-[chapterName].yml_
  containing:
    + `template`: filename of the _Rmd_ file to consider for this chapter
    + `reportTitle`: chapter title, used for section header
    + `dataFileName`: filename of the dataset of interest for this chapter,
      e.g.: 'adae.sas7bdat'
    + `reportTitleLevel`: integer with section level, e.g. 2
    + (optional) template-specific parameters, accessed in the template   via
      `params$`
        
## Output

The medical monitoring report output consists of a final output and a set of
intermidiary results.

**Final output**

A final output folder ('report' by default) containing the:

* final medical monitoring report, in a set of multiple HTML files
* required _Javascript_ libraries in the subfolder: _'libs'_
* any extra directories created during report execution, by   default: 'tables'
  and 'figures' (`extraDirs` parameter)
* (optionally) directory with patient profiles

**Intermidiary results**

A folder of intermediary results ('interim' by default)

* _Markdown_ file for each report part (one per config file)
*  associated _rds_ file containing specification of the  _Javascript_ libraries
   required for each report part (`knit_meta`)
    
# Template reports

A set of template reports are available in the `medicalMonitoring` package
itself.

**The full list of the reports and the corresponding input parameters is
available at: `? `medicalMonitoring-templates` `**.

To use a template available in the package for one of your report, your config
file should contain the corresponding name of the template via the `template`
tag and the `templatePackage` set to 'medicalMonitoring'.

For example, to include a division in the report, your YAML config file should
be formatted as:

```{yaml, eval = FALSE}
template: divisionTemplate.Rmd
templatePackage: medicalMonitoring
reportTitle: "Title for a chapter"
reportTitleLevel: 1
```

# Render a medical monitoring report

## Production mode

The function **`render_medicalMonitoringReport` renders a medical monitoring
report for production**.

```{r render_medicalMonitoringReport, eval = FALSE}

medicalMonitoring::render_medicalMonitoringReport()

```

## Zip and send the report to collaborators

A dedicated functionality is available to zip the report and send it to
colleagues within the team.

Once a report has been rendered, the user can call

```{r zipmedicalMonitoring, eval = FALSE}

medicalMonitoring::zipMedicalMonitoring()

```

This function zips the report, so that the analyses can be easily put as
attachement in a mail/uploaded to a shared drive.

If the folder is not unzipped before opening the reports, a message in the
browser reminds to unzip the documents.


## Development mode

### Modular framework

#### (Re-)run part(s) of the report

In case the creation of the entire report is time-consuming, and only part(s) of
the report have been updated, it might be interesting to only re-run some parts
of the report. Config files associated to the parts of the report that should be
rerun can be specified via the `configFiles` parameter.

```{r render_medicalMonitoringReport-configFiles, eval = FALSE}
# run one specific report
medicalMonitoring::render_medicalMonitoringReport(configFiles = "config-AE_timeprofile.yml")
# only run the listings:
medicalMonitoring::render_medicalMonitoringReport(configFiles = list.files(pattern = "listing", "config"))
```

#### Create the final medical monitoring report from the Markdown reports

To convert all created _Markdown_ files to HTML, the dedicated function
`convertMdToHtml` can be used.

```{r convertMdToHtml, eval = FALSE}

convertMdToHtml()

```

### Debug a sub-report

To debug a sub-report, it might be interesting to run only one specific R report
in the current R session, with the parameters provided by the associated config
file. This can be achieved as followed:

```{r render_medicalMonitoringReport-devel, eval = FALSE}

# get parameters from the general 'config.yml' and the specified config file
params <- getParamsFromConfig(configFile = "config-AE_timeprofile.yml")

# extract template from package if specified
if(params$templatePackage == "medicalMonitoring"){
  pathTemplate <- medicalMonitoring::getPathTemplate(file = params$template)
  file.copy(from = pathTemplate, to = ".")
}

# run a current chapter (without medical monitoring Js libraries)
# Note that Js library to have the functionality to download patient profiles is not imported
rmarkdown::render(input = params$template)

# preview a specific chapter (with medical monitoring Js libraries)
bookdown::render_book(input = params$template, preview = TRUE)
# include the index file:
bookdown::render_book(input = c("index.Rmd", params$template), preview = TRUE)

```

# Appendix

```{r sessionInfo, echo = FALSE}

pander(sessionInfo())

```