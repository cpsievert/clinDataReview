---
title: "Vignette of the `medicalMonitoring` package"
author: "Laure Cougnaud"
date: "`r format(Sys.Date(), '%B %d, %Y')`"
output: glpgStyle::html_report
vignette: >
  %\VignetteIndexEntry{Introduction to the medicalMonitoring package}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

# Introduction

The functionality to download the patient profiles require additional _Javascript_ functions:

* custom _Javascript_ functions, included in the `medicalMonitoring` package
* external _Javascript_ dependencies: _JSZip_, _JSZipUtils_

These dependencies are included once for all visualizations of the report by using:

```{r runReport, eval = FALSE}

	library(medicalMonitoring)
	
	# run the report
	# currently Js dep for plotly/table should be included manually when rendering the document
	rmarkdown::render(
		input = "medicalMonitoring-vignette.Rmd",
		output_format = glpgStyle::html_report(extra_dependencies = getJsDepMedicalMonitoring())
	)

	# bookdown: for testing
#	bookdown::render_book(
#		input = "medicalMonitoring-vignette.Rmd", 
#		new_session = FALSE, 
#		clean_envir = FALSE,
#		output_format = glpgStyle::gitbook_report(
#			split_by = 'chapter',
#			# extra dependencies to create/download zip file when clicking on a plotly element
#			extra_dependencies = getJsDepMedicalMonitoring()
#		)
#	)
	
```	

```{r options, echo = FALSE}
	
	library(knitr)
	library(plotly)
	opts_chunk$set(
		echo = TRUE, 
#		results = 'asis', 
		warning = FALSE, 
		error = FALSE, message = FALSE, cache = FALSE,
		fig.width = 8, fig.height = 7,
		fig.path = "./figures_vignette/",
		#out.width = '0.7\\textwidth', 
		fig.align = 'center')#, out.height = 0.5\\textwidth', fig.path = 'graphs/') 
	options(width = 170)#, stringsAsFactors = FALSE
	options(warn = 1)#instead of warn = 0 by default -> to have place where warnings occur in the call to Sweave function
	
	heightLineIn  <- 0.2
	
```

This package `medicalMonitoring` contains visualizations/reporting functionalities
for medical monitoring.

```{r loadPackages}

	library(medicalMonitoring)
	library(pander)

```

## Data format

The input dataset for the workflow should be a data.frame, 
usually loaded from a _SAS_ data file (`sas7bdat` format).
The label of the variables stored in the `SAS` datasets is also used
for title/captions. 

The function `loadDataADaMSDTM` can be used to load your custom `SAS` dataset(s) of
interest.
This function returns two objects:

* a list of `data.frame` containing the data for each _SAS_ dataset(s), stored
  in the `$data` slot
* a vector containing the labels for each column of the data (used e.g. for
  default titles of the figures), stored in the `$labelVars` slot

A few `sdtm` datasets from the _Pelican_ study are included in the
`glpgUtilityFct` package for the demonstration, via the dataset
`SDTMDataPelican` and corresponding variable labels `labelVarsSDTMPelican`.

```{r loadData}	
	
	library(glpgUtilityFct)
	
	data(SDTMDataPelican)
	data(labelVarsSDTMPelican)
	
	dataLB <- SDTMDataPelican$LB
	dataDM <- SDTMDataPelican$DM
	dataAE <- SDTMDataPelican$AE
	labelVars <- labelVarsSDTMPelican

```

# Data pre-processing

## Add data annotation

The `annotateData` enables to add metadata for a specific domain/dataset.

```{r annotateData}
dataLB <- annotateData(dataLB, annotations = list(data = dataDM))
pander(
	head(dataLB), 
	caption = paste("Laboratory parameters annotated with",
		"demographics information with the `annotatedData` function"
	)
)
```

# Visualizations

## Patient profiles

The interactive visualizations included in the medical monitoring package include
functionalities to link a plot to specific patient profiles report.

A standard patient profiles reports for _SDTM_ input format are created with the function:
`runPatientProfileTemplateReport`.

```{r createPatientProfilesReport, eval = FALSE}

	library(patientProfilesVis)
	
	# export example data
	dataPath <- "data";dir.create(dataPath)
	library(haven)
	dataPathFiles <- sapply(names(SDTMDataPelican), function(dm){
		# issue for empty col
		idxCol <- !sapply(SDTMDataPelican[[dm]], function(x) all(x == ""))
		dataPathDM <- file.path(dataPath, paste0(dm, ".sas7bdat"))
		write_sas(
			data = SDTMDataPelican[[dm]][, idxCol], 
			path =  dataPathDM
		)
		dataPathDM
	})
#	sapply(dataPathFiles, read_sas)
	
	# create patient profile report
	runPatientProfileTemplateReport(
		dataPath = dataPath, 
		outputFile = "subjectProfile.pdf",
		study = "Pelican",
		batch = "20180606",
		author = "Laure Cougnaud"
	)

```

## Data visualization

### Visualization of raw data

#### Time profiles

```{r timeProfiles}

labParam <- "ALT"
dataPlot <- subset(dataLB, LBTESTCD == labParam)
visitLab <- with(dataPlot, tapply(LBDY, VISIT, median))
names(visitLab) <- sub("-", "\n", names(visitLab))

# link to patient profiles
dataPlot$patientProfilePath <- paste0(
	"patientProfiles/subjectProfile-", 
	sub("/", "-", dataPlot$USUBJID), ".pdf"
)

scatterplotMonitoring(
	data = dataPlot, 
	xVar = "LBDY", yVar = "LBSTRESN",
	aesPointVar = list(color = "ACTARM", shape = "USUBJID"),
	aesLineVar = list(group = "USUBJID", color = "ACTARM"),
	hoverVar = c("USUBJID", "VISIT", "LBDY", "LBSTRESN", "COUNTRY", "ACTARM"),
	labelVars = labelVars,
	xPars = list(breaks = visitLab, labels = names(visitLab)),
	themePars = list(legend.position = "none"),
	title = paste("Actual value of", 
		getLabelParamcd(paramcd = labParam, data = dataLB, paramcdVar = "LBTESTCD", paramVar = "LBTEST")
	),
	# include link to patient profiles:
	pathVar = "patientProfilePath",
	table = TRUE, id = paste("subjectProfile", labParam, sep = "-"),
	verbose = TRUE
)

```

#### Scatterplot

```{r scatterplot}

# format data long -> wide format (one column per lab param)
dataPlot <- subset(dataLB, LBTESTCD %in% c("ALT", "ALB"))
library(reshape2)
dataPlotWide <- dcast(
	data = dataPlot,
	formula = USUBJID + VISIT + VISITNUM ~ LBTESTCD, 
	value.var = "LBSTRESN",
	fun.aggregate = mean
)

# link to patient profiles
dataPlotWide$patientProfilePath <- paste0(
	"patientProfiles/subjectProfile-", 
	sub("/", "-", dataPlotWide$USUBJID), ".pdf"
)

# scatterplot per visit
scatterplotMonitoring(
	data = dataPlotWide, 
	xVar = "ALT", yVar = "ALB",
	xLab = getLabelParamcd(paramcd = "ALT", data = dataLB, paramcdVar = "LBTESTCD", paramVar = "LBTEST"),
	yLab = getLabelParamcd(paramcd = "ALB", data = dataLB, paramcdVar = "LBTESTCD", paramVar = "LBTEST"),
	aesPointVar = list(color = "USUBJID"),
	themePars = list(legend.position = "none"),
	facetPars = list(facets = ~ VISIT),
	labelVars = labelVars,
	pathVar = "patientProfilePath",
	table = TRUE
)


```

#### eDish plot

```{r eDishPlot}

	dataALT <- subset(dataLB, LBTESTCD == "ALT")
	dataBILI <- subset(dataLB, LBTESTCD == "BILI")
	byVar <- c("USUBJID", "VISIT")
	dataPlot <- merge(
		x = dataALT, y = dataBILI[, c(byVar, "LBSTRESN")], 
		by = c("USUBJID", "VISIT"), 
		suffixes = c(".ALT", ".BILI"),
		all = TRUE
	)
	labelVars[paste0("LBSTRESN.", c("ALT", "BILI"))] <-
		paste(
			"Actual value of", 
			getLabelParamcd(paramcd = c("ALT", "BILI"), data = dataLB, paramcdVar = "LBTESTCD", paramVar = "LBTEST")
		)
	
	# link to patient profiles
	dataPlot$patientProfilePath <- paste0(
		"patientProfiles/subjectProfile-", 
		sub("/", "-", dataPlot$USUBJID), ".pdf"
	)

	# scatterplot per visit
	scatterplotMonitoring(
		data = dataPlot, 
		xVar = "LBSTRESN.ALT", yVar = "LBSTRESN.BILI",
		xLab = getLabelParamcd(paramcd = "ALT", data = dataLB, paramcdVar = "LBTESTCD", paramVar = "LBTEST"),
		yLab = getLabelParamcd(paramcd = "BILI", data = dataLB, paramcdVar = "LBTESTCD", paramVar = "LBTEST"),
		aesPointVar = list(color = "VISIT", shape = "ACTARM"),
		xTrans = "log10", yTrans = "log10",
		hoverVar = c("USUBJID"),
		themePars = list(legend.position = "bottom"),
		labelVars = labelVars,
		table = TRUE, id = "eDish",
		pathVar = "patientProfilePath"
	)

```

### Visualization of summary statistics

Summary statistics can also be visualized with the package.
These functions take as input a table of summary statistics.
Such table can e.g. computed with the `inTextSummaryTable` R package (see
corresponding package vignette for more information).

A table of counts should be provided for the sunburst and barplot visualization.
In this example, counts of adverse events are extracted for each `r labelVars["AESOC"]`
and `r labelVars["AEDECOD"]`.
Besides the counts of the number of subjects, the path to the patient profile report
for each subgroup is extracted.

```{r createCountTableAE}

	# sunburst takes as input table with counts
	library(inTextSummaryTable)
	
	# total counts: Safety Analysis Set (patients with start date for the first treatment)
	dataTotal <- subset(dataDM, RFXSTDTC != "")
	
	## patient profiles report
	
	# add path in data
	dataAE$patientProfilePath <- paste0(
		"patientProfiles/subjectProfile-", 
		sub("/", "-", dataAE$USUBJID), ".pdf"
	)
	# combine all paths across patients
	statsExtraPP <- list(
		statPatientProfilePath = function(data)	
			toString(sort(unique(data$patientProfilePath)))
	)
	
	# get default counts + stats with subjects profiles path
	statsPP <- c(
		getStats(type = "count-default"),
		list(patientProfilePath = quote(statPatientProfilePath))
	)
	
	# compute adverse event table
	tableAE <- getSummaryStatisticsTable(
					
		data = dataAE,
		rowVar = c("AESOC", "AEDECOD"),
		dataTotal = dataTotal,
		rowOrder = "total",
		labelVars = labelVars,
		
		# plotly treemap requires records (rows) for each group
		rowVarTotalInclude = "AEDECOD",
		
		## DT-output specific:
		outputType = "data.frame",
		# statistics of interest
		# for DT output, include columns with patients
		stats = statsPP, 
		# add extra 'statistic': concatenate subject IDs
		statsExtra = statsExtraPP

	)
	pander(head(tableAE)[, 1:4],
		caption = paste("Extract of the Adverse Event summary table",
			"used for the sunburst and barplot visualization"
		)
	)

```

### Sunburst

```{r sunburst}

	dataSunburst <- tableAE
	
	dataSunburst$n <- as.numeric(dataSunburst$n)
	
	# Reformat summary statistics data.frame to include the label
	# of each group in the AEDECOD column for the total
	dataSunburst['parent'] = with(dataSunburst, 
		ifelse(AEDECOD == "Total", 'Adverse events', as.character(AESOC))
	)
	dataSunburst['child'] = with(dataSunburst, 
		ifelse(AEDECOD == "Total", as.character(AESOC), as.character(AEDECOD))
	)	
	sunburstMonitoring(
		data = dataSunburst,
		parentVar = "parent", parentLab = getLabelVar(var = "AESOC", labelVars = labelVars),
		childVar = "child", childLab = getLabelVar(var = "AEDECOD", labelVars = labelVars),
		valueVar = "n", valueLab = "Number of patients with adverse events",
		pathVar = "patientProfilePath",
		verbose = TRUE
	)
	
```

# Appendix

## Session information

```{r includeSessionInfo, echo = FALSE}

	library(pander)
	pander(sessionInfo())

```
