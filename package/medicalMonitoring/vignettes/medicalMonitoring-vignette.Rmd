---
title: "Vignette of the `medicalMonitoring` package"
author: "Laure Cougnaud"
date: "`r format(Sys.Date(), '%B %d, %Y')`"
params:
  createPatientProfiles: true
output: medicalMonitoring::html_medicalMonitoring_report
vignette: >
  %\VignetteIndexEntry{Introduction to the medicalMonitoring package}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

# Introduction

```{r options, echo = FALSE}
	
	library(knitr)
	library(plotly)
	opts_chunk$set(
		echo = TRUE, 
#		results = 'asis', 
		warning = FALSE, 
		error = FALSE, message = FALSE, cache = FALSE,
		fig.width = 8, fig.height = 7,
		fig.path = "./figures_vignette/",
		#out.width = '0.7\\textwidth', 
		fig.align = 'center')#, out.height = 0.5\\textwidth', fig.path = 'graphs/') 
	options(width = 170)#, stringsAsFactors = FALSE
	options(warn = 1)#instead of warn = 0 by default -> to have place where warnings occur in the call to Sweave function
	
	heightLineIn  <- 0.2
	
```

This package `medicalMonitoring` contains visualizations/reporting functionalities
for medical monitoring.

```{r loadPackages}

	library(medicalMonitoring)
	library(pander)

```

## Report

The functionality to download the patient profiles require additional _Javascript_ functions/packages:

* custom _Javascript_ functions
* external _Javascript_ dependencies: _JSZip_, _JSZipUtils_, _FileSaver_

These dependencies are included in the `medicalMonitoring` package.

To create a report containing such visualization,
dedicated output formats should be specified in the YAML header of the document:

* for a [_Rmarkdown_](https://cran.r-project.org/package=rmarkdown) report: : `html_medicalMonitoring_report`
```
---
title: "Study name"
subtitle: "Analysis description"
output: html_medicalMonitoring_report
---
```

* for a [_bookdown_](https://cran.r-project.org/package=bookdown) report: `gitbook_medicalMonitoring_report`
```
---
title: "Study name"
subtitle: "Analysis description"
output: gitbook_medicalMonitoring_report
---
```


## Data format

The input dataset for the workflow should be a data.frame, 
usually loaded from a _SAS_ data file (`sas7bdat` format).
The label of the variables stored in the `SAS` datasets is also used
for title/captions. 

The function `loadDataADaMSDTM` can be used to load your custom `SAS` dataset(s) of
interest.
This function returns two objects:

* a list of `data.frame` containing the data for each _SAS_ dataset(s), stored
  in the `$data` slot
* a vector containing the labels for each column of the data (used e.g. for
  default titles of the figures), stored in the `$labelVars` slot

A few `sdtm` datasets from the _Pelican_ study are included in the
`glpgUtilityFct` package for the demonstration, via the dataset
`SDTMDataPelican` and corresponding variable labels `labelVarsSDTMPelican`.

```{r loadData}	
	
	library(glpgUtilityFct)
	
	data(SDTMDataPelican)
	data(labelVarsSDTMPelican)
	
	dataLB <- SDTMDataPelican$LB
	dataDM <- SDTMDataPelican$DM
	dataAE <- SDTMDataPelican$AE
	labelVars <- labelVarsSDTMPelican

```

# Data pre-processing

## Add data annotation

The `annotateData` enables to add metadata for a specific domain/dataset.

```{r annotateData}
dataLB <- annotateData(dataLB, annotations = list(data = dataDM))
pander(
	head(dataLB), 
	caption = paste("Laboratory parameters annotated with",
		"demographics information with the `annotatedData` function"
	)
)
```

# Visualizations

## Patient profiles

The interactive visualizations of the medical monitoring package include
functionalities to link a plot to specific patient profiles report.

A standard patient profiles report for _SDTM_ input format is created with the function:
`runPatientProfileTemplateReport`.

```{r createPatientProfilesReport, eval = params$createPatientProfiles, results = "hide"}

	library(patientProfilesVis)
	
	# export example data
	dataPath <- "data";dir.create(dataPath)
	library(haven)
	dataPathFiles <- sapply(names(SDTMDataPelican), function(dm){
		# issue for empty col
		idxCol <- !sapply(SDTMDataPelican[[dm]], function(x) all(x == ""))
		dataPathDM <- file.path(dataPath, paste0(dm, ".sas7bdat"))
		write_sas(
			data = SDTMDataPelican[[dm]][, idxCol], 
			path = dataPathDM
		)
		dataPathDM
	})
#	sapply(dataPathFiles, read_sas)

	# create patient profile report
	runPatientProfileTemplateReport(
		dataPath = dataPath, 
		outputFile = "patientProfiles/subjectProfile.pdf",
		study = "Pelican",
		batch = "20180606",
		author = "Laure Cougnaud",
		overwrite = TRUE
	)

```

## Data visualization

### Visualization of individual profiles

Visualization of individual profiles is available via the function
`scatterplotMonitoring`.

Subject-specific report (e.g. patient profiles) can be linked to each profile
(`pathVar` parameter).
If the user clicks on the 'P' key while hovering on the plot, or click
on the specific subject in the attached table, the specific
patient profile is opened in a new window in the browser.

#### Time profiles

```{r timeProfiles}

labParam <- "ALT"
dataPlot <- subset(dataLB, LBTESTCD == labParam)
visitLab <- with(dataPlot, tapply(LBDY, VISIT, median))
names(visitLab) <- sub("-", "\n", names(visitLab))

# link to patient profiles
dataPlot$patientProfilePath <- paste0(
	"patientProfiles/subjectProfile-", 
	sub("/", "-", dataPlot$USUBJID), ".pdf"
)

scatterplotMonitoring(
	data = dataPlot, 
	xVar = "LBDY", yVar = "LBSTRESN",
	aesPointVar = list(color = "ACTARM"),
	aesLineVar = list(group = "USUBJID", color = "ACTARM"),
	hoverVars = c("USUBJID", "VISIT", "LBDY", "LBSTRESN", "COUNTRY", "ACTARM"),
	labelVars = labelVars,
	xPars = list(breaks = visitLab, labels = names(visitLab)),
#	themePars = list(legend.position = "none"),
	title = paste("Actual value of", 
		getLabelParamcd(paramcd = labParam, data = dataLB, paramcdVar = "LBTESTCD", paramVar = "LBTEST")
	),
	# include link to patient profiles:
	pathVar = "patientProfilePath",
	table = TRUE, id = paste("subjectProfile", labParam, sep = "-"),
	verbose = TRUE
)

```

#### Scatterplot

```{r scatterplot}

# format data long -> wide format (one column per lab param)
dataPlot <- subset(dataLB, LBTESTCD %in% c("ALT", "ALB"))
library(reshape2)
dataPlotWide <- dcast(
	data = dataPlot,
	formula = USUBJID + VISIT + VISITNUM ~ LBTESTCD, 
	value.var = "LBSTRESN",
	fun.aggregate = mean
)

# link to patient profiles
dataPlotWide$patientProfilePath <- paste0(
	"patientProfiles/subjectProfile-", 
	sub("/", "-", dataPlotWide$USUBJID), ".pdf"
)

# scatterplot per visit
scatterplotMonitoring(
	data = dataPlotWide, 
	xVar = "ALT", yVar = "ALB",
	xLab = getLabelParamcd(paramcd = "ALT", data = dataLB, paramcdVar = "LBTESTCD", paramVar = "LBTEST"),
	yLab = getLabelParamcd(paramcd = "ALB", data = dataLB, paramcdVar = "LBTESTCD", paramVar = "LBTEST"),
	aesPointVar = list(color = "USUBJID"),
#	themePars = list(legend.position = "none"),
	facetPars = list(facets = ~ VISIT),
	labelVars = labelVars,
	pathVar = "patientProfilePath",
	table = TRUE
)


```

#### eDish plot

```{r eDishPlot}

	dataALT <- subset(dataLB, LBTESTCD == "ALT")
	dataBILI <- subset(dataLB, LBTESTCD == "BILI")
	byVar <- c("USUBJID", "VISIT")
	dataPlot <- merge(
		x = dataALT, y = dataBILI[, c(byVar, "LBSTRESN")], 
		by = c("USUBJID", "VISIT"), 
		suffixes = c(".ALT", ".BILI"),
		all = TRUE
	)
	labelVars[paste0("LBSTRESN.", c("ALT", "BILI"))] <-
		paste(
			"Actual value of", 
			getLabelParamcd(paramcd = c("ALT", "BILI"), data = dataLB, paramcdVar = "LBTESTCD", paramVar = "LBTEST")
		)
	
	# link to patient profiles
	dataPlot$patientProfilePath <- paste0(
		"patientProfiles/subjectProfile-", 
		sub("/", "-", dataPlot$USUBJID), ".pdf"
	)

	# scatterplot per visit
	scatterplotMonitoring(
		data = dataPlot, 
		xVar = "LBSTRESN.ALT", yVar = "LBSTRESN.BILI",
		xLab = getLabelParamcd(paramcd = "ALT", data = dataLB, paramcdVar = "LBTESTCD", paramVar = "LBTEST"),
		yLab = getLabelParamcd(paramcd = "BILI", data = dataLB, paramcdVar = "LBTESTCD", paramVar = "LBTEST"),
		aesPointVar = list(color = "VISIT", shape = "ACTARM"),
		xTrans = "log10", yTrans = "log10",
		hoverVars = c("USUBJID"),
		themePars = list(legend.position = "bottom"),
		labelVars = labelVars,
		table = TRUE, id = "eDish",
		pathVar = "patientProfilePath"
	)

```

### Visualization of summary statistics

Summary statistics can also be visualized with the package, 
via different types of visualizations:
sunburst, treemap and barplot.

Subject-specific report (e.g. patient profiles) can be linked to each profile 
(`pathVar` parameter). If the user clicks on the 'P' key while hovering on the plot, 
a zip file containing the reports for all corresponding patients is downloaded.
If the attached table is display, each row can be extended to display the links 
of the respective patient profile reports.

These functions take as input a table of summary statistics, especially counts.
Such table can e.g. computed with the `inTextSummaryTable` R package (see
corresponding package vignette for more information).

In this example, counts of adverse events are extracted for each `r labelVars["AESOC"]`
and `r labelVars["AEDECOD"]`.
Besides the counts of the number of subjects, the paths to the patient profile report
for each subgroup are extracted and combined.

```{r createCountTableAE}

	# sunburst takes as input table with counts
	library(inTextSummaryTable)
	
	# total counts: Safety Analysis Set (patients with start date for the first treatment)
	dataTotal <- subset(dataDM, RFXSTDTC != "")
	
	## patient profiles report
	
	# add path in data
	dataAE$patientProfilePath <- paste0(
		"patientProfiles/subjectProfile-", 
		sub("/", "-", dataAE$USUBJID), ".pdf"
	)
	
	# add link in data (for attached table)
	dataAE$patientProfileLink <- with(dataAE,
		paste0(
			'<a href="', patientProfilePath, 
			'" target="_blank">', USUBJID, '</a>'
		)
	)
	
	# combine all paths across patients
	# the paths should be collapsed with: ', '
	statsExtraPP <- list(
		statPatientProfilePath = function(data)	
			toString(sort(unique(data$patientProfilePath))),
		statPatientProfileLink = function(data)
			toString(sort(unique(data$patientProfileLink)))
	)
	
	# get default counts + stats with subjects profiles path
	statsPP <- c(
		getStats(type = "count-default"),
		list(
			patientProfilePath = quote(statPatientProfilePath),
			patientProfileLink = quote(statPatientProfileLink)
		)
	)
	
	# compute adverse event table
	tableAE <- getSummaryStatisticsTable(
					
		data = dataAE,
		rowVar = c("AESOC", "AEDECOD"),
		dataTotal = dataTotal,
		rowOrder = "total",
		labelVars = labelVars,
		
		# plotly treemap requires records (rows) for each group
		rowVarTotalInclude = "AEDECOD",
		
		## DT-output specific:
		outputType = "data.frame",
		# statistics of interest
		# for DT output, include columns with patients
		stats = statsPP, 
		# add extra 'statistic': concatenate subject IDs
		statsExtra = statsExtraPP

	)
	pander(head(tableAE),
		caption = paste("Extract of the Adverse Event summary table",
			"used for the sunburst and barplot visualization"
		)
	)

```

#### Sunburst

The `sunburstMonitoring` function visualizes the counts 
of hierarchical data in nested circles.

The different groups are visualized from the biggest class (root node)
in the center of the visualization to the smallest sub-groups (leaves)
on the outside of the circles.

The size of the different segments is relative the respective counts.

```{r sunburst}

	dataSunburst <- tableAE
	
	dataSunburst$n <- as.numeric(dataSunburst$n)

	sunburstMonitoring(
		data = dataSunburst,
		vars = c("AESOC", "AEDECOD"),
		valueVar = "n", valueLab = "Number of patients with adverse events",
		pathVar = "patientProfileLink", pathLab = getLabelVar(var = "USUBJID", labelVars = labelVars),
		table = TRUE,
		verbose = TRUE
	)
	
```

#### Treemap

A treemap visualizes the counts of the hierarchical data in nested
rectangles.
The area of each rectangle is proportional to the counts
of the respective group.

```{r treemap}

	dataTreemap <- tableAE
	
	dataTreemap$n <- as.numeric(dataTreemap$n)
	
	treemapMonitoring(
		data = dataTreemap,
		vars = c("AESOC", "AEDECOD"),
		valueVar = "n", valueLab = "Number of patients with adverse events",
		pathVar = "patientProfileLink", pathLab = getLabelVar(var = "USUBJID", labelVars = labelVars),
		table = TRUE,
		verbose = TRUE
	)
	
```

#### Barplot

A barplot visualizes the counts for one single variable in a specific order.

```{r barplot}

	dataPlot <- subset(tableAE, AEDECOD != "Total")
	
	dataPlot$n <- as.numeric(dataPlot$n)
	
	# create plot
	barplotMonitoring(
		data = dataPlot,
		xVar = "AEDECOD", colorVar = "AESOC",
		yVar = "n", yLab = "Number of patients with adverse events",
		labelVars = labelVars,
		pathVar = "patientProfileLink", pathLab = getLabelVar(var = "USUBJID", labelVars = labelVars),
		table = TRUE,
		verbose = TRUE
	)
	
```

### Multiple visualizations in a loop

To include multiple medical monitoring visualizations (with or without attached table)
in a loop (a.k.a in the same _Rmarkdown_ chunk), the list of visualizations
should be passed to the `knitPrintListObjects` function of the `glpgUtilityFct`
package.

```{r lab-profile-loop, results = "asis"}

	# consider only restricted set of lab parameters
	dataPlot <- subset(dataLB, LBCAT == "SPECIAL CHEMISTRY")

	# link to patient profiles
	dataPlot$patientProfilePath <- paste0(
		"patientProfiles/subjectProfile-", 
		sub("/", "-", dataPlot$USUBJID), ".pdf"
	)
	
	# 1) create plot+table for each laboratory parameter:
	library(plyr) # for ddply
	plotsLab <- dlply(dataPlot, "LBTESTCD", function(dataLBParam){
				
		paramcd <- unique(dataLBParam$LBTESTCD)
			
		scatterplotMonitoring(
			data = dataLBParam, 
			xVar = "LBDY", yVar = "LBSTRESN",
			aesPointVar = list(color = "ACTARM"),
			aesLineVar = list(group = "USUBJID", color = "ACTARM"),
			labelVars = labelVars,
			title = paste("Actual value of", 
				getLabelParamcd(paramcd = paramcd, data = dataLBParam, paramcdVar = "LBTESTCD", paramVar = "LBTEST")
			),
			# include link to patient profiles:
			pathVar = "patientProfilePath",
			table = TRUE, 
			# important: each plot should have an unique ID!
			# for unique relationship of interactivity between plot <-> table
			id = paste("labProfileLoop", paramcd, sep = "-"),
			verbose = TRUE
		)
			
	})

	# include this output in the report:
	library(glpgUtilityFct)
	listLabels <- getLabelParamcd(paramcd = names(plotsLab), data = dataLB, paramcdVar = "LBTESTCD", paramVar = "LBTEST")
	knitPrintListObjects(
		xList = plotsLab, 
		generalLabel = "lab-profile-loop",
		titles = listLabels, titleLevel = 4
	)

```

# Appendix

## Session information

```{r includeSessionInfo, echo = FALSE}

	library(pander)
	pander(sessionInfo())

```
