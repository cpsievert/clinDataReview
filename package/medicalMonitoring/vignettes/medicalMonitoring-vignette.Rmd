---
title: "Introduction to the `medicalMonitoring` package"
author: "Laure Cougnaud"
date: "`r format(Sys.Date(), '%B %d, %Y')`"
params:
  createPatientProfiles: false
output: 
  rmarkdown::html_document:
    toc: true
    toc_float: true
    toc_depth: 5
    number_sections: true
vignette: >
  %\VignetteIndexEntry{Introduction to the medicalMonitoring package}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

# Introduction

```{r options, echo = FALSE, message = FALSE}

library(knitr)
opts_chunk$set(
    echo = TRUE, 
    results = 'asis', 
    warning = FALSE, 
    error = FALSE, message = FALSE, cache = FALSE,
    fig.width = 8, fig.height = 7,
    fig.path = "./figures_vignette/",
    #out.width = '0.7\\textwidth', 
    fig.align = 'center')#, out.height = 0.5\\textwidth', fig.path = 'graphs/') 
options(width = 170)#, stringsAsFactors = FALSE
options(warn = 1)#instead of warn = 0 by default -> to have place where warnings occur in the call to Sweave function

heightLineIn  <- 0.2

```

The package `medicalMonitoring` contains visualizations/reporting
functionalities for medical monitoring.

```{r loadPackages, message = FALSE}

library(medicalMonitoring)
library(pander)
library(plotly)

```

## Data format

The input dataset for the workflow should be a `data.frame`, 
usually loaded from a _SAS_ data file (`sas7bdat` format).
The label of the variables stored in the `SAS` datasets is also used
for title/captions. 

The function `loadDataADaMSDTM` can be used to load your custom `SAS` dataset(s) of
interest.
This function returns two objects:

* a list of `data.frame`s containing the data for each _SAS_ dataset(s), stored
  in the `$data` slot
* a vector containing the labels for each column of the data (used e.g. for
  default titles of the figures), stored as _attributes_ of the list.

A few `sdtm` datasets are included in the
`clinUtils` package for the demonstration, via the dataset
`dataADaMCDISCP01` and corresponding variable labels.

```{r loadData}	

library(clinUtils)

data(dataADaMCDISCP01)
labelVars <- attr(dataADaMCDISCP01, "labelVars")

dataLB <- dataADaMCDISCP01$ADLBC
dataDM <- dataADaMCDISCP01$ADSL
dataAE <- dataADaMCDISCP01$ADAE

```

# Data pre-processing

Utility functions to automate standard pre-processing steps of the data
are available in the package.

Note that these functions are mainly useful in combination
with the specification of the parameters in 'config' file
in the medical monitoring reports (see section \@ref(renderReport)).

## Annotate data

The `annotateData` enables to add metadata for a specific domain/dataset.

```{r annotateData, message = TRUE, warning = TRUE}

dataLBAnnot <- annotateData(
    data = dataLB, 
    annotations = list(data = dataDM, vars = c("ETHNIC", "ARM")), 
    verbose = TRUE
)
pander(
    head(dataLBAnnot), 
    caption = paste("Laboratory parameters annotated with",
        "demographics information with the `annotatedData` function"
    )
)
```

## Filter data

The `filterData` enables to filter a dataset.

```{r filterData, message = TRUE, warning = TRUE}

dataLBAnnotTreatment <- filterData(
    data = dataLBAnnot, 
    filters = list(var = "ARM", value = "Placebo", rev = TRUE), 
    verbose = TRUE
)
pander(
    unique(dataLBAnnotTreatment[, c("USUBJID", "ARM")]), 
    caption = paste("Subset of laboratory parameters filtered",
        "with placebo patients"
    )
)
```

## Transform data

The `transformData` enables to convert data to a different format.

For example, the laboratory data is converted from a long format, containing
one record per endpoint * visit * subject to a wide format containing
one record per visit * subject. The endpoints are included in different
columns.

```{r transformData, message = TRUE, warning = TRUE}

eDishData <- transformData(
    data = subset(dataLB, PARAMCD %in% c("ALT", "BILI")),
    transformations = list(
        type = "pivot_wider",
        varsID = c("USUBJID", "VISIT"), 
        varsValue = c("LBSTRESN", "LBNRIND"),
        varPivot = "PARAMCD"
    ),
    verbose = TRUE,
    labelVars = labelVars
)
pander(head(eDishData))

```

## Process data

The `processData` function executes all the pre-processing steps described in the previous section
at once.

```{r processData}

dataLBAnnotTreatment2 <- processData(
    data = dataLB,
    processing = list(
        list(annotate = list(data = dataDM, vars = c("ETHNIC", "ARM"))),
        list(filter = list(var = "ARM", value = "Placebo", rev = TRUE))
    ),
    verbose = TRUE
)

identical(dataLBAnnotTreatment, dataLBAnnotTreatment2)

```

# Visualizations

A vignette for the visualizations of `medicalMonitoring is
available
[here](`r vignette("medicalMonitoring-dataVisualizationVignette", "medicalMonitoring")`).

Alternatively, the vignette can be reached with 

```{r dataVisVignette, eval = FALSE}

vignette("medicalMonitoring-dataVisualizationVignette", "medicalMonitoring")

```


# Medical monitoring report {#renderReport}

Utility functions are provided to run a standard medical monitoring report.
Please note that the examples in this section are only informative,
and not evaluated in the vignette itself.

## File structure

### Input

The input for the medical monitoring report consists of a set of _Rmardown_
files and a `config` directory. Below more specifications.

**Rmd files**

A set of _Rmarkdown_ files in the working directory should be

* _index.Rmd_ file, containing the front page of the document.  
This file should be formatted as a _Rmarkdown_ report with _YAML_ header,
with `output` set to: `medicalMonitoring::gitbook_medicalMonitoring_report`

* multiple Rmd files, one for each chapter (or template for multiple
  chapters)

**Config files**

There should be a `config` directory containing:

* a general configuration file: _config.yml_ with:
    
    + `pathDataFolder`: path to a directory containing input data in
  _sas7bdat_       or _xpt_ format
    + `patientProfilesPath`(optional) : path to a directory containing the patient profiles
    + `study` (optional): study name
    + `version` (optional): data version, e.g. batch
    
* a configuration file for each chapter, as: _config-[chapterName].yml_ containing:
    + `template`: filename of the _Rmd_ file to consider for this chapter
    + `reportTitle`: chapter title, used for section header
    + `dataFileName`: filename of the dataset of interest for this chapter, e.g.: 'adae.sas7bdat'
    + `reportTitleLevel`: integer with section level, e.g. 2
    + (optional) template-specific parameters, accessed in the template
        via `params$`
        
#### Output

The medical monitoring report output consists of a final output and a set of
intermidiary results.

**Final output**

A final output folder ('report' by default) containing the:

* final medical monitoring report, in a set of
multiple HTML files
* required _Javascript_ libraries in the subfolder: _'libs'_
* any extra directories created during report execution, by
    default: 'tables' and 'figures' (`extraDirs` parameter)
* (optionally) directory with patient profiles

**Intermidiary results**

A folder of intermediary results ('interim' by default)

* _Markdown_ file for each report part (one per config file)
*  associated _rds_ file containing specification of the
    _Javascript_ libraries required for each report part (`knit_meta`)
    
## Template reports

A set of template reports are available in the `medicalMonitoring` package
itself.

**The full list of the reports and the corresponding input parameters is available
at: `? `medicalMonitoring-templates` `**.

To use a template available in the package for one of your report,
your config file should contain the corresponding name of the template via
the `template` tag and the `templatePackage` set to 'medicalMonitoring'.

For example, to include a division in the report, your YAML config file should be formatted
as:

```{yaml, eval = FALSE}
template: divisionTemplate.Rmd
templatePackage: medicalMonitoring
reportTitle: "Title for a chapter"
reportTitleLevel: 1
```

## Render a medical monitoring report

### Production mode

The function **`render_medicalMonitoringReport` renders a medical monitoring report
for production**.

```{r render_medicalMonitoringReport, eval = FALSE}

medicalMonitoring::render_medicalMonitoringReport()

```

### Development mode

#### Modular framework

##### (Re-)run part(s) of the report

In case the creation of the entire report is time-consuming, and
only part(s) of the report have been updated, it might be interesting to
only re-run some parts of the report. Config files associated to the
parts of the report that should be rerun can be specified via the
`configFiles` parameter.

```{r render_medicalMonitoringReport-configFiles, eval = FALSE}
# run one specific report
medicalMonitoring::render_medicalMonitoringReport(configFiles = "config-AE_timeprofile.yml")
# only run the listings:
medicalMonitoring::render_medicalMonitoringReport(configFiles = list.files(pattern = "listing", "config"))
```

##### Create the final medical monitoring report from the Markdown reports

To convert all created _Markdown_ files to HTML, the dedicated function `convertMdToHtml`
can be used.

```{r convertMdToHtml, eval = FALSE}

convertMdToHtml()

```

#### Debug a sub-report

To debug a sub-report, it might be interesting to run
only one specific R report in the current R session, with
the parameters provided by the associated config file.
This can be achieved as followed:

```{r render_medicalMonitoringReport-devel, eval = FALSE}

# get parameters from the general 'config.yml' and the specified config file
params <- getParamsFromConfig(configFile = "config-AE_timeprofile.yml")

# extract template from package if specified
if(params$templatePackage == "medicalMonitoring"){
  pathTemplate <- medicalMonitoring::getPathTemplate(file = params$template)
  file.copy(from = pathTemplate, to = ".")
}

# run a current chapter (without medical monitoring Js libraries)
# Note that Js library to have the functionality to download patient profiles is not imported
rmarkdown::render(input = params$template)

# preview a specific chapter (with medical monitoring Js libraries)
bookdown::render_book(input = params$template, preview = TRUE)
# include the index file:
bookdown::render_book(input = c("index.Rmd", params$template), preview = TRUE)

```

# For package tester/developer

To run the different tests in the package (e.g. with `R CMD check`),
the [orca](https://github.com/plotly/orca) tool is required.
Please check the installation guidelines available at:
https://github.com/plotly/orca#installation

# Appendix

## Session information

```{r includeSessionInfo, echo = FALSE}

library(pander)
pander(sessionInfo())

```
